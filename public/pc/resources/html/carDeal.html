<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>车辆业务-西南石油大学保卫处</title>
	<link rel="stylesheet" href="../css/reset.css">
	<link rel="stylesheet" href="../libs/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/cardeal.css">
    <script src="../libs/jquery-3.3.1.min.js"></script>
    <script src="../libs/bootstrap/dist/js/bootstrap.min.js"></script>
</head>
<body>
	<div class="main-content">
        <header>
            <nav class="navbar navbar-default">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <a class="navbar-brand" href="#">车辆业务办理-西南石油大学保卫处</a>
                    </div>
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="#">退出登录</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">个人设置 <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                    <li><a href="#">修改密码</a></li>
                                    <li><a href="#">联系我们</a></li>
                                    <li><a href="#">个人中心</a></li>
                                    <li><a href="#">个人中心</a></li>
                                    <li role="separator" class="divider"></li>
                                    <li><a href="#">联系我们</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <img src="../images/logo.png">
            <ol class="breadcrumb">
                <li><a href="./main.html">首页</a></li>
                <li class="active"><a href="#">车辆预约</a></li>
            </ol>
        </header>
        <section class="contain content">
            <p class="msg">尊敬的<span id="user">某某某</span>用户，您剩余预约次数为<span id="number">几</span>次，请填写要预约的车辆信息</p>
            <div class="for-form">
                <form class="form-horizontal" id="form-submit">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">员工电话：</label>
                        <div class="col-sm-6">
                            <input type="text" placeholder="输入员工电话" id="tel" name="tel" class="form-control" >
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">预约车牌号：</label>
                        <div class="col-sm-6">
                            <input type="text" placeholder="例如：川A123456" id="car_no" name="car_no" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">预约人姓名：</label>
                        <div class="col-sm-6">
                            <input type="text" placeholder="输入预约人姓名" id="name" name="name" class="form-control" >
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">到访时间：</label>
                        <div class="col-sm-6">
                            <select id="visit_time" name="visit_time" class="form-control">
                                <option class="special">选择明天的到访时间</option>
                                <option>07:00</option>
                                <option>08:00</option>
                                <option>09:00</option>
                                <option>10:00</option>
                                <option>11:00</option>
                                <option>12:00</option>
                                <option>13:00</option>
                                <option>14:00</option>
                                <option>15:00</option>
                                <option>16:00</option>
                                <option>17:00</option>
                                <option>18:00</option>
                                <option>19:00</option>
                                <option>20:00</option>
                                <option>21:00</option>
                                <option>22:00</option>
                                <option>23:00</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">到访事由：</label>
                        <div class="col-sm-6">
                            <input type="text" placeholder="输入到访事由" id="visit_reason" name="visit_reasons" class="form-control" >
                        </div>
                    </div>
                    <p id="warning"></p>
                    <div class="form-group">
                        <div class="col-sm-offset-4 col-sm-1">
                            <button type="submit" class="btn btn-default" id="btn-submit">预约</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        <footer>
            <ul>
                <li>西南石油大学保卫部（处）（武装部）&nbsp;&nbsp;&nbsp;地址：四川省成都市新都区新都大道8号</li>
                <li>电话：028-83032110&nbsp;&nbsp;&nbsp;邮编：610500</li>
            </ul>
        </footer>
    </div>

	<script>
        $(document).ready(function(){ 
            let storage = window.localStorage;
            let emp_no = storage.getItem(emp_no);
            var i = 0;
            $.get('http://www.huangcongfu.cn/vms/index/index/login_check', function(request){
                if(i = 0,i < request.length, i ++) {
                    if(request[i].emp_no == emp_no) {
                        $('#user').text(request[i].name);
                        $('#number').text(request[i].number);
                    }
                }

                // request.array.forEach(element => {
                //    if(element.emp_no == emp_no) {
                //         $('#user').text(element.name);
                //         $('#number').text(element.number);
                //    }
                // });
            });
        });

        function getTomorrowDate() {
            var date = new Date();
            date.setTime(date.getTime() + 24 * 60 * 60 * 1000);
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var day = date.getDate();
            month = month < 10 ? ('0' + month) : month;
            day = day < 10 ? ('0' + day) : day;
            return year + '-' + month + '-' + day;
        }

        function checkCarNo(carNo) {
            // 新能源车牌号正则
            const regNEV = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}(([0-9]{5}[DF]$)|([DF][A-HJ-NP-Z0-9][0-9]{4}$))/;
            // 其他汽车正则
            const regOTC = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}[A-HJ-NP-Z0-9]{4}[A-HJ-NP-Z0-9挂学警港澳]{1}$/;
            if (carNo.length === 7) {
                return regOTC.test(carNo);
            } else if (carNo.length === 8) {
                return regNEV.test(carNo);
            } else {
                return false;
            }
        }

		$('#btn-submit').on('click', function(e){
            e.preventDefault();
            const form = document.querySelector('#form-submit');
            let validateFlag = true;
            var visit_time = $('#visit_time option:selected').val();

            function _alert(errormsg) {
                $('#warning').text(errormsg);
				validateFlag = false;
            }


            if (validateFlag) {
                validateFlag && (form.tel.value || _alert('请填写员工手机号！'));
                validateFlag && (form.car_no.value || _alert('请填写车牌号！'));
                validateFlag && (checkCarNo(form.car_no.value) || _alert('请填写合法的车牌号！'));
                validateFlag && (form.name.value || _alert('请填写预约人姓名！'));
                validateFlag && (visit_time || _alert('请选择到访时间！'));
                validateFlag && (form.visit_reason.value || _alert('请填写到访事由！'));
            }

            if(validateFlag) {
                _alert('预约成功！');
                visit_time = getTomorrowDate() + ' ' + $('#visit_time option:selected').val() + ':00';
                var send_data = {
			        tel: form.tel.value,
                    car_no: form.car_no.value,
                    name: form.name.value,
                    visit_time: visit_time,
                    visit_reason: form.visit_reason.value,
			    };

                $.post('http://www.huangcongfu.cn/vms/index/index/login_check',send_data,function(response){
                    if(response) {
                        _alert('预约成功！');
                    }else {
                        _alert('您今天已经没有预约次数了')
                    }
                })
            }
        });
        

        // $('#btn-submit').on('click', function() {
        //     // var form = document.getElementById('form-submit');
        //     const form = document.querySelector('#form-submit');
        //     let validateFlag = true;
        //     const _alert = (errMsg) => {
        //         weui.topTips(errMsg, 1500);
        //         validateFlag = false;
        //     };
        //     // function _alert(errMsg) {
                
        //     // }

        //     if (validateFlag) {
        //         validateFlag && (form.tel.value || _alert('请填写员工手机号！'));
        //         validateFlag && (form.car_no.value || _alert('请填写车牌号！'));
        //         validateFlag && (checkCarNo(form.car_no.value) || _alert('请填写合法的车牌号！'));
        //         validateFlag && (form.name.value || _alert('请填写预约人姓名！'));
        //         validateFlag && (form.visit_time.value || _alert('请选择到访时间！'));
        //         validateFlag && (form.visit_reason.value || _alert('请填写到访事由！'));
        //     }

        //     if(validateFlag) {
        //         const loading = weui.loading('提交中...');
        //         try {
        //             $.post("{:url('save_reservation')}", $('#form-submit').serializeArray(), (response) => {
        //                 if (response) {
        //                 loading.hide(() => {
        //                     weui.toast(response.msg, {
        //                     duration: 1000,
        //                     callback: () => {
        //                         // window.location.replace(response.url);
        //                         window.location.href = response.url;
        //                     }
        //                     });
        //                 })
        //                 } else {
        //                 loading.hide();
        //                 weui.topTips('预约失败！您今天已没有预约次数了，请明天再预约。', 3000);
        //                 }
        //             });
        //         } catch (error) {
        //             loading.hide();
        //             console.log('erroe', error);
        //             weui.topTips('网络错误！提交失败。', 1500);
        //         }
        //     }
        // });
	</script>
</body>
</html>