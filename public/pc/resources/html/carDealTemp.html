<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>车辆预约</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../libs/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../libs/weui/weui.min.css">
    <script src="../libs/jquery-3.3.1.min.js"></script>
    <script src="../libs/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../libs/bootbox/bootbox.min.js"></script>
    <script src="../scripts/common_alert.js"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../scripts/common.js"></script>
    <script src="../libs/laydate/laydate.js"></script>
    <script src="../libs/weui/weui.min.js"></script>

    <style  rel="stylesheet">
        .main {
            margin: 0 auto;
            width: 800px;
            background-color: #F8F8F8;
            padding: 50px 0;
        }
        .tips {
            margin: 0 auto;
            width: 800px;
            color: #666;
        }
        .special {
            display: none;
        }
        #warning {
            color: red;
            text-align: center;
        }
        .laydate-footer-btns span:hover {
            color: #337AB7 !important;
        }
        .required-icon {
            color: red;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-default navbar-static-top ">
            <div class="container-fluid">
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav" id="nav">
                        <!-- <li><a href="./carDeal.html">车辆预约</a></li>
                        <li><a href="./yearcheck.html">年审</a></li>
                        <li><a href="./carRecord.html">预约记录</a></li>
                        <li><a href="./yearRecord.html">年审记录</a></li>
                        <li class="active"><a href="./carDealTemp.html">临时出入<span class="sr-only">(current)</span></a></li> -->
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="javascript:void(0);" onclick="logout()">退出登录</a></li>
                        <!-- <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">个人设置 <span class="caret"></span></a>
                            <ul class="dropdown-menu">
                                <li><a href="./updatepass.html">修改密码</a></li>
                                    <li role="separator" class="divider"></li>
                                <li><a href="#">联系我们</a></li>
                            </ul>
                        </li> -->
                    </ul> 
                </div>
            </div>
        </nav>
    </header>
    <div class="tips">
        <p>尊敬的<span id="emp_no"></span>用户，请填写要预约的车辆信息：</p>
    </div>
	<div class="main">
        <form class="form-horizontal" id="form-submit">
            <div class="form-group">
                <label class="col-sm-4 control-label">一卡通号：</label>
                <div class="col-sm-6">
                    <input type="number" placeholder="输入一卡通号" id="campus_card_no" name="campus_card_no" class="form-control" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">姓名：</label>
                <div class="col-sm-6">
                    <input type="text" placeholder="输入姓名" id="name" name="name" class="form-control" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">单位：</label>
                <div class="col-sm-6">
                    <input type="text" placeholder="输入单位名称" id="unit" name="unit" class="form-control" >
                </div>
            </div>
            
            <div class="form-group">
                <label class="col-sm-4 control-label">申请事由：</label>
                <div class="col-sm-6">
                    <input type="text" placeholder="输入申请事由" id="apply_reason" name="apply_reason" class="form-control" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">预约形式：</label>
                <div class="col-sm-6">
                    <select id="apply_type" name="apply_type" class="form-control">
                        <option value="单位预约">单位预约</option>
                        <option value="个人预约">个人预约</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">车主姓名：</label>
                <div class="col-sm-6">
                    <input type="text" placeholder="输入车主姓名" id="car_owner_name" name="car_owner_name" class="form-control" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">车牌号：</label>
                <div class="col-sm-6">
                    <input type="text" placeholder="普通车辆：川A12345，新能源车辆：川A123456" id="car_no" name="car_no" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">车辆种类：</label>
                <div class="col-sm-6">
                    <select id="car_type" name="car_type" class="form-control">
                        <option value="轿车">轿车</option>
                        <option value="客车">客车</option>
                        <option value="货车">货车</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">行驶证编号：</label>
                <div class="col-sm-6">
                    <input type="text" placeholder="输入行驶证编号" id="driving_license_no" name="driving_license_no" class="form-control" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">联系电话：</label>
                <div class="col-sm-6">
                    <input type="number" placeholder="输入联系电话" id="tel" name="tel" class="form-control" >
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">进校时间：</label>
                <div class="col-sm-6">
                    <select id="visit_time" name="visit_time" class="form-control">
                        <option>07:00</option>
                        <option>08:00</option>
                        <option>09:00</option>
                        <option>10:00</option>
                        <option>11:00</option>
                        <option>12:00</option>
                        <option>13:00</option>
                        <option>14:00</option>
                        <option>15:00</option>
                        <option>16:00</option>
                        <option>17:00</option>
                        <option>18:00</option>
                        <option>19:00</option>
                        <option>20:00</option>
                        <option>21:00</option>
                        <option>22:00</option>
                        <option>23:00</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-4 control-label">离校时间：</label>
                <div class="col-sm-6">
                    <select id="leave_time" name="leave_time" class="form-control">
                        <option>07:00</option>
                        <option>08:00</option>
                        <option>09:00</option>
                        <option>10:00</option>
                        <option>11:00</option>
                        <option>12:00</option>
                        <option>13:00</option>
                        <option>14:00</option>
                        <option>15:00</option>
                        <option>16:00</option>
                        <option>17:00</option>
                        <option>18:00</option>
                        <option>19:00</option>
                        <option>20:00</option>
                        <option>21:00</option>
                        <option>22:00</option>
                        <option>23:00</option>
                    </select>
                </div>
            </div>
        </form>
        <form class="form-horizontal" id="form-image">
            <div class="form-group">
              <label class="col-sm-4 control-label">校内员工一卡通<span class="required-icon">*</span>：</label>
              <div class="col-sm-6">
                <div class="weui-uploader" id="campus-card-uploader">
                  <div class="weui-uploader__hd">
                    <input type="hidden" class="image-id" name="campus_card_id" id="campus_card_id">
                  </div>
                  <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files" id="uploaderFiles"></ul>
                    <div class="weui-uploader__input-box">
                      <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="col-sm-4 control-label">车主行驶证<span class="required-icon">*</span>：</label>
              <div class="col-sm-6">
                <div class="weui-uploader" id="driving-license-uploader">
                  <div class="weui-uploader__hd">
                    <input type="hidden" class="image-id" name="driving_license_id" id="driving_license_id">
                  </div>
                  <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files" id="uploaderFiles"></ul>
                    <div class="weui-uploader__input-box">
                      <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="col-sm-offset-4 col-sm-1">
                <button type="submit" class="btn btn-primary" id="btn-submit">提 交</button>
              </div>
            </div>
            <p id="warning"></p>
          </form>
    </div>

<script>
    $(function() {
        // 获取到用户名
        const emp_no = localStorage.getItem('emp_no');
        if (!emp_no) {
            ui_alert('登录身份失效，请重新登录！', function() {
                window.location.href = '../../index.html';
            });
        }
        $('#emp_no').text(emp_no);
        var menus = JSON.parse(localStorage.getItem('menus'));
		var html = menus.map(function(item) {
			if (item.name == '临时出入') {
				return '<li class="active"><a href="'+ item.url +'">'+ item.name +'</a></li>';
			} else {
				return '<li><a href="'+ item.url +'">'+ item.name +'</a></li>';
			}
		});
        $('#nav').append(html);
        // 图片上传注册
        uploadFactory('#driving-license-uploader').init();
        uploadFactory('#campus-card-uploader').init();
    });

    $('#campus_card_no').on('change', function() {
        var capus_card_no = $(this).val();
        if (capus_card_no.length === 12) {
            $.get('/vms/index/business/get_emp_info', { emp_no: capus_card_no }, function(data) {
                $('#name').val(data['emp_name']);
                $('#unit').val(data['emp_unit']);
            });
        }
    });

    // 车牌字母转换为大写
    $('#car_no').on('change', function() {
        $(this).val($(this).val().toUpperCase());
    });

    //单击提交按钮验证表单信息并向服务器上传数据
    $('#btn-submit').on('click', function(e){
        e.preventDefault();
        const form = document.querySelector('#form-submit');
        let validateFlag = true;

        function _alert(errormsg, element) {
            $('#warning').text(errormsg);
            $(element).parent().addClass('has-error');
            validateFlag = false;
        }

        if (validateFlag) {
            validateFlag && (form.name.value || _alert('请填写姓名！'));
            validateFlag && (form.unit.value || _alert('请填写单位！'));
            validateFlag && (form.campus_card_no.value || _alert('请填写一卡通号！'));
            validateFlag && (form.campus_card_no.value.length === 12 || _alert('请填写长度为12位的一卡通号！！'));
            validateFlag && (form.apply_reason.value || _alert('请填写申请事由！'));
            validateFlag && (form.car_owner_name.value || _alert('请填写车主姓名！'));
            validateFlag && (form.car_no.value || _alert('请填写车牌号！'));
            validateFlag && (Utils.checkCarNo(form.car_no.value) || _alert('请填写合法的车牌号！'));
            validateFlag && (form.driving_license_no.value || _alert('请填写行驶证编号！'));
            validateFlag && (form.tel.value || _alert('请填写联系电话！'));
            validateFlag && (form.tel.value.length === 11 || _alert('请填写长度为11位的手机号！'));
            validateFlag && (form.visit_time.value || _alert('请选择入校时间！'));
            validateFlag && (form.leave_time.value || _alert('请选择离校时间！'));
        }

        if (form.visit_time.value > form.leave_time.value) {
            return _alert('离校时间不能小于预约时间！');
        }

        const imageForm = document.querySelector('#form-image');
        if (validateFlag) {
            validateFlag && (imageForm.campus_card_id.value || _alert('请上传校园一卡通！'));
            validateFlag && (imageForm.driving_license_id.value || _alert('请上传车辆行驶证！'));
        }

        if(validateFlag) {
            const formData = $('#form-submit').serializeArray();
            const imageData = $('#form-image').serializeArray();
            const data = formData.concat(imageData);
            $.post('/vms/index/business/save_temp_reservation', data, (response) => {
                if (response.code) {
                    ui_alert(response.msg, function() {
                        window.location.reload();
                    });
                } else {
                    ui_alert(response.msg);
                }
            });
        }
    });

    // 聚焦元素时清除错误状态
    $('#form-submit').on('focus', 'input', function() {
        $(this).parent().removeClass('has-error');
        $('#warning').text('');
    });

    // 图片上传工厂模式
function uploadFactory(uploadSelector) {
	let uploadCount = 0;
	let uploadIdDom = $(uploadSelector + ' input.image-id');
	let image = null;
	return {
		init: function() {
			// 绑定上传
			weui.uploader(uploadSelector, {
				url: '/vms/index/business/image_upload',
				auto: true,
				type: 'file',
				fileVal: 'image',
				compress: {
					width: 1600,
					height: 1600,
					quality: 1,
				},
				onBeforeQueued: function(files) {
					if(["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0){
						ui_alert('请上传图片');
						return false;
					}
					if(this.size > 10 * 1024 * 1024){
						ui_alert('请上传不超过10M的图片');
						return false;
					}
					if (files.length > 1) { // 防止一下子选中过多文件
						ui_alert('最多只能上传1张图片，请重新选择');
						return false;
					}
					if (uploadCount + 1 > 1) {
						ui_alert('最多只能上传1张图片');
						return false;
					}

					++uploadCount;
				},
				onQueued: function(){
					image = this;
					// console.log(this);
				},
				onBeforeSend: function(data, headers){
					// console.log(this, data, headers);
					// $.extend(data, { test: 1 }); // 可以扩展此对象来控制上传参数
					// $.extend(headers, { Origin: 'http://127.0.0.1' }); // 可以扩展此对象来控制上传头部
					// return false; // 阻止文件上传
				},
				onProgress: function(procent){
					// console.log(this, procent);
				},
				onSuccess: function (ret) {
					uploadIdDom.val(ret);
				},
				onError: function(err){
					// console.log(this, err);
				}
			});

			// 绑定图片预览
			$(uploadSelector + ' #uploaderFiles').on('click', 'li', function() {
				const self = this;
				const url = $(this).css('background-image').match(/url\((.*?)\)/)[1].replace(/"/g, '');
				const id = $(this).attr('data-id');
				const gallery = weui.gallery(url, {
					className: 'custom-gallery',
					onDelete: function() {
						ui_alert('确定删除该图片？', function() {
							uploadCount--;
							uploadIdDom.val('');
							image.stop();
							$(self).remove();
							gallery.hide();
						})
					}
				});
			});
		}
	}
}
</script>
</body>
</html>