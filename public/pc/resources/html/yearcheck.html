<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>年审</title>
	<link rel="stylesheet" href="../css/reset.css">
	<link rel="stylesheet" href="../css/common.css">
	<link rel="stylesheet" href="../libs/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="../css/yearcheck.css">
	<link rel="stylesheet" href="../libs/weui/weui.min.css">
	<style>
		.weui-uploader__hd {
			padding-bottom: 0;
		}
		.weui-uploader__title {
			margin-top: 8px;
			margin-bottom: 0;
		}
		.weui-uploader__files > li {
			margin-top: 10px;
		}
		.clause-list {
			padding-left: 30px;
		}
	</style>
</head>
<body>
	<header>
		<nav class="navbar navbar-default navbar-static-top ">
			<div class="container-fluid">
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav" id="nav">
						<!-- <li><a href="./carDeal.html">车辆预约</a></li>
						<li  class="active"><a href="#">年审<span class="sr-only">(current)</span></a></li>
						<li><a href="./carRecord.html">预约记录</a></li>
						<li><a href="./yearRecord.html">年审记录</a></li>
						<li id="temp_reservation"><a href="./carDealTemp.html">临时出入</a></li> -->
					</ul>
					<ul class="nav navbar-nav navbar-right">
						<li><a href="javascript:void(0);" onclick="logout()">退出登录</a></li>
						<!-- <li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">个人设置 <span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li><a href="./updatepass.html">修改密码</a></li>
									<li role="separator" class="divider"></li>
								<li><a href="#">联系我们</a></li>
							</ul>
						</li> -->
					</ul> 
				</div>
			</div>
		</nav>
	</header>
	<div class="tips">
		<p>尊敬的<span id="emp_no"></span>用户，请填写您车辆的年审信息，我们在收到信息后1-2天内会录入：</p>
	</div>
	<div class="main">
		<form class="form-horizontal" id="form-submit">
			<div class="form-group">
				<label class="col-sm-4 control-label">申请人姓名<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<input type="text" placeholder="填写申请人姓名" readonly id="applicant" name="applicant" class="form-control" >
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">车主姓名<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<input type="text" placeholder="填写车主姓名" id="car_owner" name="car_owner" class="form-control">
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">申请人与车主关系 ：</label>
				<div class="col-sm-6">
					<input type="text" placeholder="填写申请人与车主关系" id="relationship" name="relationship" class="form-control" >
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">车辆号牌<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<input type="text" placeholder="例如：川A12345" id="car_no" name="car_no" class="form-control" >
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">联系方式<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<input type="text" placeholder="填写电话号码" id="tel" name="tel" class="form-control" >
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">排量（升）：</label>
				<div class="col-sm-6">
					<input type="text" placeholder="填写车辆排量" id="displacement" name="displacement" class="form-control" >
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">申请人所在单位<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<input type="text" placeholder="填写申请人所在单位" id="applicant_unit" name="applicant_unit" class="form-control" >
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">申请类别<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<select id="apply_type" name="apply_type" class="form-control">
						<option value="新办">新办</option>
						<option value="续卡">续卡</option>
					</select>
				</div>
			</div>
		</form>
		<form class="form-horizontal" id="form-image">
			<div class="form-group">
				<label class="col-sm-4 control-label">车辆行驶证扫描件或照片<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<div class="weui-uploader" id="driving-license-uploader">
						<div class="weui-uploader__hd">
							<input type="hidden" class="image-id" name="driving_license_id" id="driving_license_id">
						</div>
						<div class="weui-uploader__bd">
							<ul class="weui-uploader__files" id="uploaderFiles"></ul>
							<div class="weui-uploader__input-box">
								<input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">校园一卡通扫描件或照片<span class="required-icon">*</span>：</label>
				<div class="col-sm-6">
					<div class="weui-uploader" id="campus-card-uploader">
						<div class="weui-uploader__hd">
							<input type="hidden" class="image-id" name="campus_card_id" id="campus_card_id">
						</div>
						<div class="weui-uploader__bd">
							<ul class="weui-uploader__files" id="uploaderFiles"></ul>
							<div class="weui-uploader__input-box">
								<input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">关系有效证明资料扫描件或照片：</label>
				<div class="col-sm-6">
					<div class="weui-uploader" id="relationship-proof-uploader">
						<div class="weui-uploader__hd">
							<p class="weui-uploader__title">非申请人本人车辆，需提供申请人与车主关系的有效证明资料扫描件或照片。</p>
							<input type="hidden" class="image-id" name="relationship_proof_id" id="relationship_proof_id">
						</div>
						<div class="weui-uploader__bd">
							<ul class="weui-uploader__files" id="uploaderFiles"></ul>
							<div class="weui-uploader__input-box">
								<input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">有效缴费凭据扫描件或照片：</label>
				<div class="col-sm-6">
					<div class="weui-uploader" id="payment-proof-uploader">
						<div class="weui-uploader__hd">
							<p class="weui-uploader__title">校内有固定停车位的车辆，申请人提供有效缴费凭据扫描件或照片。</p>
							<input type="hidden" class="image-id" name="payment_proof_id" id="payment_proof_id">
						</div>
						<div class="weui-uploader__bd">
							<ul class="weui-uploader__files" id="uploaderFiles"></ul>
							<div class="weui-uploader__input-box">
								<input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-sm-4 control-label">租借协议扫描件或照片：</label>
				<div class="col-sm-6">
					<div class="weui-uploader" id="loan-agreement-uploader">
						<div class="weui-uploader__hd">
							<p class="weui-uploader__title">租借他人停车位的车辆，申请人提供租借协议扫描件或照片。</p>
							<input type="hidden" class="image-id" name="loan_agreement_id" id="loan_agreement_id">
						</div>
						<div class="weui-uploader__bd">
							<ul class="weui-uploader__files" id="uploaderFiles"></ul>
							<div class="weui-uploader__input-box">
								<input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-6 col-sm-offset-4">
					<label>
						<input type="checkbox" id="clause-check"> 阅读并同意<a id="clause">《车主（驾驶员）承诺条款》</a>
					</label>
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-offset-4 col-sm-1">
					<button type="submit" class="btn btn-primary" id="btn-submit">提 交</button>
				</div>
			</div>
			<p id="warning"></p>
		</form>
	</div>
	<div class="modal fade" tabindex="-1" role="dialog" id="modal_clause">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title" id="modal-title">车主（驾驶员）承诺条款</h4>
			</div>
			<div class="modal-body" id="modal-body">
				<ol class="clause-list">
					<li>接受并配合门卫（巡查）人员的验证检查，服从指挥，文明行车，不鸣笛、不扰民。</li>
					<li>进入校园后，限速30公里/小时行驶，避让一切行人和非机动车。</li>
					<li>按规划的停车位沿指示方向规范停车，不乱停乱放，并保管好车内物品。</li>
				</ol>
				<p>本人郑重声明，已阅知并承诺履行上述条款，如有违犯，相关责任均由本人承担。</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-dismiss="modal">确 定</button>
			</div>
			</div>
		</div>
	</div>
	<script src="../libs/node_modules/babel-core/browser.min.js"></script>
	<script src="../libs/node_modules/babel-core/browser-polyfill.min.js"></script>
	<script src="../libs/jquery-3.3.1.min.js"></script>
	<script src="../libs/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="../libs/bootbox/bootbox.min.js"></script>
	<script src="../scripts/common_alert.js"></script>
	<script src="../scripts/utils.js"></script>
	<script src="../libs/weui/weui.min.js"></script>
	<script src="../scripts/common.js"></script>
	<script type="text/babel">
	// 获取到用户名
	$(document).ready(function(){ 
		const emp_no = localStorage.getItem('emp_no');
		if (!emp_no) {
			ui_alert('登录身份失效，请重新登录！', function() {
				window.location.href = '../../index.html';
			});
		}
		$('#emp_no').text(emp_no);
		// $.get('/vms/index/business/get_emp_level', { emp_no: emp_no }, function(data) {
		// 		if (data == 3) {
		// 				$('#temp_reservation').show();
		// 		} else {
		// 				$('#temp_reservation').hide();
		// 		}
		// });
		$.get('/vms/index/business/get_emp_info', { emp_no: emp_no }, function(data) {
			$('#applicant').val(data['emp_name']);
			$('#applicant_unit').val(data['emp_unit']);
		});
		var menus = JSON.parse(localStorage.getItem('menus'));
		var html = menus.map(function(item) {
			if (item.name == '年审') {
				return '<li class="active"><a href="'+ item.url +'">'+ item.name +'</a></li>';
			} else {
				return '<li><a href="'+ item.url +'">'+ item.name +'</a></li>';
			}
		});
		$('#nav').append(html);
		// 图片上传注册
		uploadFactory('#driving-license-uploader').init();
		uploadFactory('#campus-card-uploader').init();
		uploadFactory('#relationship-proof-uploader').init();
		uploadFactory('#payment-proof-uploader').init();
		uploadFactory('#loan-agreement-uploader').init();
	});

	$('#clause').on('click', function(e) {
		$('#modal_clause').modal('show');
	});

	$('#btn-submit').on('click', function(e){
		e.preventDefault();
		const isClauseCheck = $('#clause-check').is(':checked');
		if (!isClauseCheck) {
			return ui_alert('请阅读并同意《车主（驾驶员）承诺条款》!');
		}
		const form = document.querySelector('#form-submit');
		let validateFlag = true;

		function _alert(errormsg, element) {
			$('#warning').text(errormsg);
            $(element).parent().addClass('has-error');
			validateFlag = false;
		}

		if (validateFlag) {
			validateFlag && (form.applicant.value || _alert('请填写申请人姓名！', form.applicant));
			validateFlag && (form.car_owner.value || _alert('请填写车主姓名！', form.car_owner));
			validateFlag && (form.car_no.value || _alert('请填写车牌号！', form.car_no));
			validateFlag && (Utils.checkCarNo(form.car_no.value) || _alert('请填写合法的车牌号！', form.car_no));
			validateFlag && (form.tel.value || _alert('请填写电话号码！', form.tel));
			validateFlag && (form.applicant_unit.value || _alert('请填写申请人所在单位！', form.applicant_unit));
		}

		const imageForm = document.querySelector('#form-image');
		if (validateFlag) {
			validateFlag && (imageForm.driving_license_id.value || _alert('请上传车辆行驶证！'));
			validateFlag && (imageForm.campus_card_id.value || _alert('请上传校园一卡通！'));
		}

		if(validateFlag) {
			const formData = $('#form-submit').serializeArray();
			const imageData = $('#form-image').serializeArray();
			const data = formData.concat(imageData);
			const images = imageData.filter((item) => item.value).map((item) => item.value);
			$.post('/vms/index/business/save_mot_test', { data, images }, function(response){
				if(response.code) {
					ui_alert(response.msg, function() {
						window.location.reload();
					});
				}else {
					ui_alert(response.msg);
				}
			})
		}
	});

	// 聚焦元素时清除错误状态
    $('#form-submit').on('focus', 'input', function() {
        $(this).parent().removeClass('has-error');
        $('#warning').text('');
    });

		// 车牌字母转换为大写
    $('#car_no').on('change', function() {
        $(this).val($(this).val().toUpperCase());
    });

// 图片上传工厂模式
function uploadFactory(uploadSelector) {
	let uploadCount = 0;
	let uploadIdDom = $(uploadSelector + ' input.image-id');
	let image = null;
	return {
		init: function() {
			// 绑定上传
			weui.uploader(uploadSelector, {
				url: '/vms/index/business/image_upload',
				auto: true,
				type: 'file',
				fileVal: 'image',
				compress: {
					width: 1600,
					height: 1600,
					quality: 1,
				},
				onBeforeQueued: function(files) {
					if(["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0){
						ui_alert('请上传图片');
						return false;
					}
					if(this.size > 10 * 1024 * 1024){
						ui_alert('请上传不超过10M的图片');
						return false;
					}
					if (files.length > 1) { // 防止一下子选中过多文件
						ui_alert('最多只能上传1张图片，请重新选择');
						return false;
					}
					if (uploadCount + 1 > 1) {
						ui_alert('最多只能上传1张图片');
						return false;
					}

					++uploadCount;
				},
				onQueued: function(){
					image = this;
					// console.log(this);
				},
				onBeforeSend: function(data, headers){
					// console.log(this, data, headers);
					// $.extend(data, { test: 1 }); // 可以扩展此对象来控制上传参数
					// $.extend(headers, { Origin: 'http://127.0.0.1' }); // 可以扩展此对象来控制上传头部
					// return false; // 阻止文件上传
				},
				onProgress: function(procent){
					// console.log(this, procent);
				},
				onSuccess: function (ret) {
					uploadIdDom.val(ret);
				},
				onError: function(err){
					// console.log(this, err);
				}
			});

			// 绑定图片预览
			$(uploadSelector + ' #uploaderFiles').on('click', 'li', function() {
				const self = this;
				const url = $(this).css('background-image').match(/url\((.*?)\)/)[1].replace(/"/g, '');
				const id = $(this).attr('data-id');
				const gallery = weui.gallery(url, {
					className: 'custom-gallery',
					onDelete: function() {
						ui_alert('确定删除该图片？', function() {
							uploadCount--;
							uploadIdDom.val('');
							image.stop();
							$(self).remove();
							gallery.hide();
						})
					}
				});
			});
		}
	}
}
</script>
</body>
</html>