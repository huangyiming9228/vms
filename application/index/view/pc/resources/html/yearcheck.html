<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>车辆业务-西南石油大学保卫处</title>
	<link rel="stylesheet" href="../css/reset.css">
	<link rel="stylesheet" href="../libs/bootstrap/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="../css/index.css">
	<link rel="stylesheet" href="../css/yearcheck.css">
    <script src="../libs/jquery-3.3.1.min.js"></script>
    <script src="../libs/bootstrap/dist/js/bootstrap.min.js"></script>
</head>
<body>
	<div class="main-content">
        <header>
            <nav class="navbar navbar-default"> 
                <div class="container-fluid">
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
						<ul class="nav navbar-nav">
							<li><a href="./carDeal.html">车辆预约</a></li>
							<li class="active"><a href="#">年审<span class="sr-only">(current)</span></a></li>
							<li><a href="./carRecord.html">预约记录</a></li>
							<li><a href="./yearRecord.html">年审记录</a></li>
						</ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="#">退出登录</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">个人设置 <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                    <li><a href="#">修改密码</a></li>
                                    <li role="separator" class="divider"></li>
                                    <li><a href="#">联系我们</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <section class="contain">
			<p class="msg">尊敬的<span id="user">某某某</span>用户，请填写您车辆的年审信息，我们在收到信息后1-2天内会录入：</p>
			<div class="for-form">
				<form class="form-horizontal" id="form-submit">
					<div class="form-group">
						<label class="col-sm-4 control-label">申请人姓名<span class="required-icon">*</span>：</label>
						<div class="col-sm-6">
							<input type="text" placeholder="填写申请人姓名" id="applicant" name="applicant" class="form-control" >
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">车主姓名<span class="required-icon">*</span>：</label>
						<div class="col-sm-6">
							<input type="text" placeholder="填写车主姓名" id="car_owner" name="car_owner" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">申请人与车主关系：</label>
						<div class="col-sm-6">
							<input type="text" placeholder="填写申请人与车主关系" id="relationship" name="relationship" class="form-control" >
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">车辆号牌<span class="required-icon">*</span>：</label>
						<div class="col-sm-6">
							<input type="text" placeholder="例如：川A123456" id="car_no" name="car_nos" class="form-control" >
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">联系方式<span class="required-icon">*</span>：</label>
						<div class="col-sm-6">
							<input type="text" placeholder="填写电话号码" id="tel" name="tel" class="form-control" >
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">排量（升）：</label>
						<div class="col-sm-6">
							<input type="text" placeholder="填写车辆排量" id="displacement" name="displacements" class="form-control" >
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">申请人所在单位<span class="required-icon">*</span>：</label>
						<div class="col-sm-6">
							<input type="text" placeholder="填写申请人所在单位" id="applicant_unit" name="applicant_units" class="form-control" >
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">申请类别<span class="required-icon">*</span>：</label>
						<div class="col-sm-6">
							<select id="apply_type" name="apply_type" class="form-control">
								<option value="新办">新办</option>
								<option value="续卡">续卡</option>
							</select>
						</div>
					</div>
					<p>资料采集：</p>
					<div class="form-group">
						<label class="col-sm-4 control-label">车辆行驶证原件<span>(0/1)</span><span class="required-icon">*</span>：</label>
						<div class="col-sm-6 item">
							<img id="driving_license_id" src=""/>		
							<label>
								<input type="file" id="chooseImage" name="file">
								<img class="driving_license_id up-img" src="../images/up-logo.png" alt="lorem ipsum dolor sit" data-address='' title="点击上传图片"/>	
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">校园一卡通<span>(0/1)</span><span class="required-icon">*</span>:</label>
						<div class="col-sm-6 item">
							<img id="campus_card_id" src=""/>		
							<label>
								<input type="file" id="chooseImage" name="file">
								<img class="campus_card_id up-img" src="../images/up-logo.png" alt="lorem ipsum dolor sit" data-address='' title="点击上传图片"/>	
							</label>
						</div>
					</div>
					<p>非申请人本人车辆，需提供申请人与车主关系的有效证明资料复印件：</p>
					<div class="form-group">
						<label class="col-sm-4 control-label">申请人与车主关系有效证明资料复印件<span>(0/1)</span>：</label>
						<div class="col-sm-6 item">
							<img id="relationship_proof_id" src=""/>		
							<label>
								<input type="file" id="chooseImage" name="file">
								<img class="relationship_proof_id up-img" src="../images/up-logo.png" alt="lorem ipsum dolor sit" data-address='' title="点击上传图片"/>	
							</label>
						</div>
					</div>
					<p>校内有固定停车位的车辆，申请人提供有效缴费凭据原件：</p>
					<div class="form-group">
						<label class="col-sm-4 control-label">有效缴费凭据原件<span>(0/1)</span>：</label>
						<div class="col-sm-6 item">
							<img id="payment_proof_id" src=""/>		
							<label>
								<input type="file" id="chooseImage" name="file">
								<img class="payment_proof_id up-img" src="../images/up-logo.png" alt="lorem ipsum dolor sit" data-address='' title="点击上传图片"/>	
							</label>
						</div>
					</div>
					<p>租借他人停车位的车辆，申请人提供租借协议原件 + 复印件：</p>
					<div class="form-group">
						<label class="col-sm-4 control-label">租借协议原件<span>(0/1)</span>：</label>
						<div class="col-sm-6 item">
							<img id="loan_agreement_original_id" src=""/>		
							<label>
								<input type="file" id="chooseImage" name="file">
								<img class="loan_agreement_original_id up-img" src="../images/up-logo.png" alt="lorem ipsum dolor sit" data-address='' title="点击上传图片"/>	
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="col-sm-4 control-label">租借协议复印件<span>(0/1)</span>：</label>
						<div class="col-sm-6 item">
							<img id="loan_agreement_copy_id" src=""/>		
							<label>
								<input type="file" id="chooseImage" name="file">
								<img class="loan_agreement_copy_id up-img" src="../images/up-logo.png" alt="lorem ipsum dolor sit" data-address='' title="点击上传图片"/>	
							</label>
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-4 col-sm-10">
							<div class="checkbox">
							<label>
								<input type="checkbox">阅读并同意
							</label>
							<span id="deal-file">《车主（驾驶员）承诺条款》</span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<div class="col-sm-offset-4 col-sm-10">
							<button type="submit" class="btn btn-default" id="btn-submit">提交</button>
						</div>
					</div>
				</form>
				<div class="no-display" id="file-box">
					<h4>《车主（驾驶员）承诺条款》</h4>
					<ul>
						<li>1.接受并配合门卫（巡查）人员的验证检查，服从指挥，文明行车，不鸣笛、不扰民。</li>
						<li>2.进入校园后，限速30公里/小时行驶，避让一切行人和非机动车。</li>
						<li>3.按规划的停车位沿指示方向规范停车，不乱停乱放，并保管好车内物品。</li>
					</ul>
					<p class="sure">本人郑重声明，已阅知并承诺履行上述条款，如有违犯，相关责任均由本人承担。</p>
					<button id="btn" class="btn btn-default">确定</button>
				</div>
			</div>
        </section>
    </div>

	<script>
		$('#chooseImage').on('change',function(){
				var filePath = $(this).val(),         //获取到input的value，里面是文件的路径
					fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase(),
					src = window.URL.createObjectURL(this.files[0]); //转成可以在本地预览的格式
					
				// 检查是否是图片
				if( !fileFormat.match(/.png|.jpg|.jpeg/) ) {
					error_prompt_alert('上传错误,文件格式必须为：png/jpg/jpeg');
					return;  
				}
		
				$('#up-img').attr('src',src);
		});

		$('#deal-file').on('click',function() {
			$('#file-box').removeClass('no-display');
		});

		$('#btn').on('click',function() {
			$('#file-box').addClass('no-display');
		});

        $(document).ready(function(){ 
            let storage = window.localStorage;
            let emp_no = storage.getItem(emp_no);
            var i = 0;
            $.get('http://www.huangcongfu.cn/vms/index/index/login_check', function(request){
                if(i = 0,i < request.length, i ++) {
                    if(request[i].emp_no == emp_no) {
                        $('#user').text(request[i].name);
                        $('#number').text(request[i].number);
                    }
                }

                // request.array.forEach(element => {
                //    if(element.emp_no == emp_no) {
                //         $('#user').text(element.name);
                //         $('#number').text(element.number);
                //    }
                // });
            });
        });

        function getTomorrowDate() {
            var date = new Date();
            date.setTime(date.getTime() + 24 * 60 * 60 * 1000);
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var day = date.getDate();
            month = month < 10 ? ('0' + month) : month;
            day = day < 10 ? ('0' + day) : day;
            return year + '-' + month + '-' + day;
        }

        function checkCarNo(carNo) {
            // 新能源车牌号正则
            const regNEV = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}(([0-9]{5}[DF]$)|([DF][A-HJ-NP-Z0-9][0-9]{4}$))/;
            // 其他汽车正则
            const regOTC = /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}[A-HJ-NP-Z0-9]{4}[A-HJ-NP-Z0-9挂学警港澳]{1}$/;
            if (carNo.length === 7) {
                return regOTC.test(carNo);
            } else if (carNo.length === 8) {
                return regNEV.test(carNo);
            } else {
                return false;
            }
        }

		$('#btn-submit').on('click', function(e){
            e.preventDefault();
            const form = document.querySelector('#form-submit');
            let validateFlag = true;
            var visit_time = $('#visit_time option:selected').val();

            function _alert(errormsg) {
                $('#warning').text(errormsg);
				validateFlag = false;
            }


            if (validateFlag) {
                validateFlag && (form.tel.value || _alert('请填写员工手机号！'));
                validateFlag && (form.car_no.value || _alert('请填写车牌号！'));
                validateFlag && (checkCarNo(form.car_no.value) || _alert('请填写合法的车牌号！'));
                validateFlag && (form.name.value || _alert('请填写预约人姓名！'));
                validateFlag && (visit_time || _alert('请选择到访时间！'));
                validateFlag && (form.visit_reason.value || _alert('请填写到访事由！'));
            }

            if(validateFlag) {
                _alert('预约成功！');
                visit_time = getTomorrowDate() + ' ' + $('#visit_time option:selected').val() + ':00';
                var send_data = {
			        tel: form.tel.value,
                    car_no: form.car_no.value,
                    name: form.name.value,
                    visit_time: visit_time,
                    visit_reason: form.visit_reason.value,
			    };

                $.post('http://www.huangcongfu.cn/vms/index/index/login_check',send_data,function(response){
                    if(response) {
                        _alert('预约成功！');
                    }else {
                        _alert('您今天已经没有预约次数了')
                    }
                })
            }
        });
        

        // $('#btn-submit').on('click', function() {
        //     // var form = document.getElementById('form-submit');
        //     const form = document.querySelector('#form-submit');
        //     let validateFlag = true;
        //     const _alert = (errMsg) => {
        //         weui.topTips(errMsg, 1500);
        //         validateFlag = false;
        //     };
        //     // function _alert(errMsg) {
                
        //     // }

        //     if (validateFlag) {
        //         validateFlag && (form.tel.value || _alert('请填写员工手机号！'));
        //         validateFlag && (form.car_no.value || _alert('请填写车牌号！'));
        //         validateFlag && (checkCarNo(form.car_no.value) || _alert('请填写合法的车牌号！'));
        //         validateFlag && (form.name.value || _alert('请填写预约人姓名！'));
        //         validateFlag && (form.visit_time.value || _alert('请选择到访时间！'));
        //         validateFlag && (form.visit_reason.value || _alert('请填写到访事由！'));
        //     }

        //     if(validateFlag) {
        //         const loading = weui.loading('提交中...');
        //         try {
        //             $.post("{:url('save_reservation')}", $('#form-submit').serializeArray(), (response) => {
        //                 if (response) {
        //                 loading.hide(() => {
        //                     weui.toast(response.msg, {
        //                     duration: 1000,
        //                     callback: () => {
        //                         // window.location.replace(response.url);
        //                         window.location.href = response.url;
        //                     }
        //                     });
        //                 })
        //                 } else {
        //                 loading.hide();
        //                 weui.topTips('预约失败！您今天已没有预约次数了，请明天再预约。', 3000);
        //                 }
        //             });
        //         } catch (error) {
        //             loading.hide();
        //             console.log('erroe', error);
        //             weui.topTips('网络错误！提交失败。', 1500);
        //         }
        //     }
        // });
	</script>
</body>
</html>